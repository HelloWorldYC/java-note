<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis一点点细节 | java</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/java-note/images/myfavicon.png">
    <meta name="description" content="java 学习笔记">
    
    <link rel="preload" href="/java-note/assets/css/0.styles.f5140cd9.css" as="style"><link rel="preload" href="/java-note/assets/js/app.b4e76d81.js" as="script"><link rel="preload" href="/java-note/assets/js/2.af1aff5f.js" as="script"><link rel="preload" href="/java-note/assets/js/1.b527e11e.js" as="script"><link rel="preload" href="/java-note/assets/js/44.668b7294.js" as="script"><link rel="prefetch" href="/java-note/assets/js/10.a284a5f0.js"><link rel="prefetch" href="/java-note/assets/js/11.63d78869.js"><link rel="prefetch" href="/java-note/assets/js/12.411148a2.js"><link rel="prefetch" href="/java-note/assets/js/13.a6d8e7b5.js"><link rel="prefetch" href="/java-note/assets/js/14.cde1b595.js"><link rel="prefetch" href="/java-note/assets/js/15.c815dbff.js"><link rel="prefetch" href="/java-note/assets/js/16.f89ca76d.js"><link rel="prefetch" href="/java-note/assets/js/17.b43ef999.js"><link rel="prefetch" href="/java-note/assets/js/18.f1ca2df4.js"><link rel="prefetch" href="/java-note/assets/js/19.d907bdbe.js"><link rel="prefetch" href="/java-note/assets/js/20.ba076c76.js"><link rel="prefetch" href="/java-note/assets/js/21.f7bf66e3.js"><link rel="prefetch" href="/java-note/assets/js/22.941a47dc.js"><link rel="prefetch" href="/java-note/assets/js/23.b9156e83.js"><link rel="prefetch" href="/java-note/assets/js/24.07b1cd92.js"><link rel="prefetch" href="/java-note/assets/js/25.5be29da5.js"><link rel="prefetch" href="/java-note/assets/js/26.2dd5fb9f.js"><link rel="prefetch" href="/java-note/assets/js/27.02358944.js"><link rel="prefetch" href="/java-note/assets/js/28.306847f8.js"><link rel="prefetch" href="/java-note/assets/js/29.270a4d53.js"><link rel="prefetch" href="/java-note/assets/js/3.313cba90.js"><link rel="prefetch" href="/java-note/assets/js/30.bfc6c248.js"><link rel="prefetch" href="/java-note/assets/js/31.fffd5f77.js"><link rel="prefetch" href="/java-note/assets/js/32.ac467fad.js"><link rel="prefetch" href="/java-note/assets/js/33.70479154.js"><link rel="prefetch" href="/java-note/assets/js/34.4e48aa0b.js"><link rel="prefetch" href="/java-note/assets/js/35.724f00a7.js"><link rel="prefetch" href="/java-note/assets/js/36.170daa7d.js"><link rel="prefetch" href="/java-note/assets/js/37.53f51c04.js"><link rel="prefetch" href="/java-note/assets/js/38.4e8ccf8d.js"><link rel="prefetch" href="/java-note/assets/js/39.4677e6bb.js"><link rel="prefetch" href="/java-note/assets/js/4.953ceea1.js"><link rel="prefetch" href="/java-note/assets/js/40.b55e76ef.js"><link rel="prefetch" href="/java-note/assets/js/41.fe541156.js"><link rel="prefetch" href="/java-note/assets/js/42.6f36570a.js"><link rel="prefetch" href="/java-note/assets/js/43.f7e4b8ba.js"><link rel="prefetch" href="/java-note/assets/js/45.02de4e09.js"><link rel="prefetch" href="/java-note/assets/js/46.0b9a3a33.js"><link rel="prefetch" href="/java-note/assets/js/47.6978a7f4.js"><link rel="prefetch" href="/java-note/assets/js/48.036c9aa2.js"><link rel="prefetch" href="/java-note/assets/js/49.a77067f4.js"><link rel="prefetch" href="/java-note/assets/js/5.5d5d288a.js"><link rel="prefetch" href="/java-note/assets/js/50.50d9308b.js"><link rel="prefetch" href="/java-note/assets/js/51.f5490448.js"><link rel="prefetch" href="/java-note/assets/js/52.446d87e0.js"><link rel="prefetch" href="/java-note/assets/js/53.8779543f.js"><link rel="prefetch" href="/java-note/assets/js/54.94dc9f6f.js"><link rel="prefetch" href="/java-note/assets/js/55.8d7d0d45.js"><link rel="prefetch" href="/java-note/assets/js/56.69820a1b.js"><link rel="prefetch" href="/java-note/assets/js/57.fcaa4ea6.js"><link rel="prefetch" href="/java-note/assets/js/58.0fd49238.js"><link rel="prefetch" href="/java-note/assets/js/59.79c04a76.js"><link rel="prefetch" href="/java-note/assets/js/6.3c0fcba4.js"><link rel="prefetch" href="/java-note/assets/js/60.f35494a3.js"><link rel="prefetch" href="/java-note/assets/js/61.39888619.js"><link rel="prefetch" href="/java-note/assets/js/62.0d59237f.js"><link rel="prefetch" href="/java-note/assets/js/63.6d693cde.js"><link rel="prefetch" href="/java-note/assets/js/64.47d66d8e.js"><link rel="prefetch" href="/java-note/assets/js/65.fbcd58d8.js"><link rel="prefetch" href="/java-note/assets/js/66.962b42b1.js"><link rel="prefetch" href="/java-note/assets/js/67.563f535c.js"><link rel="prefetch" href="/java-note/assets/js/68.0c74e1c4.js"><link rel="prefetch" href="/java-note/assets/js/69.242f9577.js"><link rel="prefetch" href="/java-note/assets/js/7.93de78a3.js"><link rel="prefetch" href="/java-note/assets/js/70.3a3fb003.js"><link rel="prefetch" href="/java-note/assets/js/vendors~docsearch.d01c1f3f.js">
    <link rel="stylesheet" href="/java-note/assets/css/0.styles.f5140cd9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/java-note/" class="home-link router-link-active"><!----> <span class="site-name">java</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>校园信息交流平台项目</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>简易RPC框架项目</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>内功</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>MySQL</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Redis</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java-note/Java/内功/Redis/Redis总体架构.html" class="sidebar-link">Redis总体架构</a></li><li><a href="/java-note/Java/内功/Redis/Redis一点点细节.html" class="active sidebar-link">Redis一点点细节</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>操作系统</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>知识点自测速记</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="redis-持久化机制"><a href="#redis-持久化机制" class="header-anchor">#</a> Redis 持久化机制</h2> <h3 id="aof-重写"><a href="#aof-重写" class="header-anchor">#</a> AOF 重写</h3> <p>AOF 重写（rewrite）是一个有歧义的名字，该功能是<strong>通过读取数据库中的键值对来实现</strong>，程序<strong>无须</strong>对现有 AOF 文件进行任何读写、分析或者写入操作。<br>
AOF 重写触发时机有两种，一种是通过设置AOF文件大小，默认是 64 MB，超过则重写；另一种是设置当前 AOF 大小和上一次重写时 AOF 大小的比值，超过比值则重写。<br> <strong>既然 AOF 重写是读取数据库中键值对来实现的，为什么不直接采用 RDB，那样不是会更简单吗？</strong><br>
这个问题其实也就是 AOF 和 RDB 的优劣势问题，各有优势也各有短板，AOF 主要比 RDB 好的地方就是实时性比较好，数据安全性比较高，可以导出 AOF 文件进行分析调错。</p> <h2 id="redis-事务"><a href="#redis-事务" class="header-anchor">#</a> Redis 事务</h2> <p>Redis 事务实际上是一系列命令的打包执行，与 MySQL 这些的事务不一样。<br>
Redis 事务不支持原子性，但支持持久性（AOF 和 RDB）。<br> <strong>如何解决 Redis 事务的缺陷？</strong> 可以使用 Lua 脚本，一段 Lua 脚本可以当作一条命令来执行，一段 Lua 脚本的执行过程中不会有其他脚本或 Redis 命令同时执行，保证了操作不会被打断（<strong>隔离性</strong>）。但是，如果操作失败并不会回滚数据，因此使用 Lua 脚本也不满足原子性。</p> <h2 id="redis-性能优化"><a href="#redis-性能优化" class="header-anchor">#</a> Redis 性能优化</h2> <ul><li>使用批量操作减少网络传输：减少了 Round Trip Time (RTT，往返时间)，即数据在网络上传输的时间；也减少了 发送命令的 socket I/O 成本。</li> <li>大量 key 集中过期问题：定期删除过期 key 任务需要在主线程中执行，若在这过程有大量 key 过期，会影响请求的响应。解决方法一是给 key 设置随机过期时间；二是开启 lazy-free 延迟释放，让 redis 采用异步方式延迟释放 key 使用的内存，交给子线程处理。</li> <li>处理 Redis big key：一是分割 big key；二是手动清理；三是采用合适的数据结构。</li> <li>处理 redis hotkey：一是读写分离；二是使用 Redis 集群，将热点数据分散存储在多个节点上；三是使用二级缓存，将热点数据存放一份到 JVM 本地内存中。</li></ul> <h3 id="惰性删除-lazy-deletion-和延迟释放-lazy-free-的区别"><a href="#惰性删除-lazy-deletion-和延迟释放-lazy-free-的区别" class="header-anchor">#</a> 惰性删除（lazy deletion）和延迟释放（lazy free）的区别？</h3> <p>&quot;Lazy Free&quot; 和 &quot;Lazy Deletion&quot; 都是 Redis 中与内存管理和键的过期相关的概念，但它们有不同的含义和用途。</p> <ol><li><p><strong>Lazy Free（惰性释放）：</strong></p> <ul><li>&quot;Lazy Free&quot; 是指 Redis 在内存管理方面的一种策略。</li> <li>当一个键被删除或过期时，Redis 并不立即释放与该键相关联的内存。相反，它会将这些键的内存标记为 &quot;tombstone&quot;（墓碑），并稍后在内存需要时，通过回收这些标记为 &quot;tombstone&quot; 的内存来进行重用。</li> <li>这种策略的优势在于避免了频繁的内存分配和释放操作，从而减少了内存碎片的产生，提高了性能。然而，它可能会导致 Redis 的内存占用在键被删除或过期后仍然会有一定时间的增加。</li></ul></li> <li><p><strong>Lazy Deletion（惰性删除）：</strong></p> <ul><li>&quot;Lazy Deletion&quot; 是指 Redis 在处理键的过期时的一种策略。</li> <li>当一个键过期时，并不会立即将它从数据库中删除。相反，它会等到有客户端请求访问该键时，才会在访问时检查键是否过期，并在需要时删除。</li> <li>这种策略的优势在于避免了在键过期时产生立即的删除操作，从而减轻了对性能的影响。然而，它可能会导致过期键在数据库中积压，直到有客户端请求访问这些键。</li></ul></li></ol> <p>综上所述，&quot;Lazy Free&quot; 主要关注内存管理，通过延迟释放内存来提高性能并减少内存碎片。&quot;Lazy Deletion&quot; 则关注键的过期处理，通过延迟实际删除过期键来减轻性能影响。这两种策略在 Redis 中都是为了优化性能和内存使用而采取的手段。</p> <h2 id="redis-内存碎片"><a href="#redis-内存碎片" class="header-anchor">#</a> Redis 内存碎片</h2> <p>Redis 内存碎片率计算公式：mem_fragmentation_ratio （内存碎片率）= used_memory_rss (操作系统实际分配给 Redis 的物理内存空间大小)/ used_memory(Redis 内存分配器为了存储数据实际申请使用的内存空间大小)<br> <strong>一定不要误认为 used_memory_rss 减去 used_memory 值就是内存碎片的大小！！！这不仅包括内存碎片，还包括其他进程开销，以及共享库、堆栈等的开销。</strong></p> <h2 id="redis-生产问题"><a href="#redis-生产问题" class="header-anchor">#</a> Redis 生产问题</h2> <ul><li>缓存穿透：大量请求的 key 不合理，根本不存在于缓存中，也不存在于数据库中。解决方法一是缓存无效 key，二是使用布隆过滤器。<strong>布隆过滤器说某个元素存在，小概率会误判。布隆过滤器说某个元素不在，那么这个元素一定不在。</strong></li> <li>缓存击穿：请求的 key 对应的是热点数据 ，该数据存在于数据库中，但不存在于缓存中（通常是因为缓存中的那份数据已经过期）。解决方法一是设置热点数据永不过期或过期时间较长，二是提前将热点数据存入缓存并设置合理过期时间，三是设置互斥锁保证只有一个请求落到数据库。</li> <li>缓存雪崩：缓存在同一时间大面积的失效，导致大量的请求都直接落到了数据库上，对数据库造成了巨大的压力，比如实例宕机。针对 Redis 服务不可用解决方法一是采用集群避免单机出现问题，二是限流避免同时处理大量请求；针对热点缓存同时失效解决方法一是随机设置不同的过期时间，二是缓存永不失效，三是设置二级缓存。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/java-note/Java/内功/Redis/Redis总体架构.html" class="prev">
        Redis总体架构
      </a></span> <span class="next"><a href="/java-note/Java/内功/操作系统/导论.html">
        操作系统导论
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/java-note/assets/js/app.b4e76d81.js" defer></script><script src="/java-note/assets/js/2.af1aff5f.js" defer></script><script src="/java-note/assets/js/1.b527e11e.js" defer></script><script src="/java-note/assets/js/44.668b7294.js" defer></script>
  </body>
</html>
