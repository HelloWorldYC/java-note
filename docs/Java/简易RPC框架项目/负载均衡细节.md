---
title: '负载均衡细节'
---

# 一致性哈希(Consistent hash)负载均衡

## 普通哈希算法的优缺点
- 优点：简单易用，大多数分库分表规则就采取的这种方式。一般是提前根据数据量，预先估算好分区数。
- 缺点：由于扩容或收缩节点导致节点数量变化时，节点的映射关系需要重新计算，会导致数据进行迁移。所以扩容时通常采用翻倍扩容，避免数据映射全部被打乱，导致全量迁移的情况，这样只会发生50%的数据迁移。

## 一致性哈希算法的官方说法
一致性哈希算法在1997年由麻省理工学院提出，是一种特殊的哈希算法，在移除或者添加一个服务器时，能够尽可能小地改变已存在的服务请求与处理请求服务器之间的映射关系。一致性哈希解决了简单哈希算法在分布式哈希表( Distributed Hash Table，DHT) 中存在的动态伸缩等问题。

## 一致性哈希映射模型
一致性哈希映射模型本质上是一个环形队列哈希映射模型。这种方案，其基础还是基于取模运算。对 2^32 取模，即 Hash 值区间为：[0, 2^32-1]。要进行映射，包括两个部分的映射：映射服务和映射请求。  
- 映射服务：将服务地址（ip+端口）按照一定规则构造出特定的识别码（如md5码），再用识别码对2^32取模，确定服务在Hash值区间对应的位置。
- 映射请求：在发起请求时，我们往往会带上参数，而这些参数，就可以被我们用来确定具体调用哪一个服务。映射过程也是经过计算特定识别码、取余等一系列运算。  

假设服务器和请求映射位置如下：
<div align="left"><img src="./asserts/一致性哈希映射请求图一.jpg" width="50%"/></div> 

**请求和服务器的对应规则是：取服务 Hash 值大于请求 Hash 值的第一个服务作为实际的调用服务。** 也就是说，按上面的图所示，R1 请求将调用 Node1 服务，R2 请求将调用 Node2 服务，R3 请求将调用 Node3 服务。  

当新增服务节点或者删除服务节点（服务器宕机）时，如下图所示：

<div align="left"><img src="./asserts/一致性哈希映射请求图二.jpg" width="45%"/><img src="./asserts/一致性哈希映射请求图三.jpg" width="46.5%"/></div> 

可以看出，当新增、删除服务时，受影响的请求是有限的，受影响的区间仅仅是增加或者宕机服务器在哈希环空间中，逆时针方向遇到的第一台服务器之间的区间，其它区间不会受到影响。

上面的情况是比较理想的，实际上计算服务 Hash 值的时候，是很难这么巧的，有可能会映射成下面这种情况：
<div align="left"><img src="./asserts/一致性哈希映射请求图四.jpg" width="50%"/></div> 

这种情况下，就会导致大部分请求都会被映射到 Node1 上，这就叫做**数据倾斜**。   
**怎么解决数据倾斜呢？ 加入虚拟节点。**   
所谓虚拟节点，就是在哈希计算时，使用 `IP+端口+编号` 的形式进行哈希值计算，其中的编号就是 0 到 n 的数字。由于 `IP+端口` 是一样的，所以这 n 个节点都是指向的同一台机器，从而达到同一服务映射多个节点的目的。
<div align="left"><img src="./asserts/一致性哈希映射请求图五.jpg" width="50%"/></div> 

一致性哈希算法中，加入虚拟节点，可以解决数据倾斜问题。在面试的过程中，如果听到了类似于数据倾斜的字眼，那大概率是在问一致性哈希算法和虚拟节点。


## 参考文献
- https://cn.dubbo.apache.org/zh-cn/blog/2019/05/01/dubbo-%e4%b8%80%e8%87%b4%e6%80%a7hash%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e5%ae%9e%e7%8e%b0%e5%89%96%e6%9e%90/
- https://segmentfault.com/a/1190000021234695