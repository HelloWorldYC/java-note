---
title: '八股自测速记之JVM'
---

> 这篇文章以问答的形式用于快速回顾知识点以及用于自测。  
> 因为知识点相当多，即使在看时能够理解记住，但过后也往往只是有印象，大概知道是什么东西，但想回答出来却总是卡壳，看了忘，忘了看。因此，这篇文章用于帮助速记回忆，自测时可以由这些点延伸。  




## Java 内存区域
#### Java 虚拟机的内存区域是怎么分配的？   
堆（其中包括字符串常量池）、各个线程分配的内存（其中包括程序计数器、虚拟机栈、本地方法栈）   
本地内存（包括直接内存、元空间（元空间包括运行时常量池））**不属于**虚拟机运行时数据区域。

#### 什么是程序计数器？程序计数器有什么作用？
程序计数器是一块较小的内存，可以看作是当前线程所执行字节码的行号指示器。  
作用：改变程序计数器来依次读取指令；在多线程情况下记录当前线程执行的位置。

#### Java 虚拟机栈的生命周期？存入的是哪些信息？
Java 虚拟机栈的生命周期随线程创建而创建，随线程死亡而死亡。   
存入的是栈帧，栈帧随方法调用而入栈，随方法结束而出栈，无论是正常结束还是异常结束。  
栈帧组成：局部变量表、操作数栈、动态链接、方法返回地址。  
局部变量表：存放基本数据类型和对象引用。  
操作数栈：存放方法调用过程中产生的中间计算结果。  
动态链接：服务于一个方法需要调用其他方法的场景，将符号引用转换为调用方法的直接引用。  

#### 程序运行时栈可能会出现什么错误？
- `StackOverFlowError`：若栈的内存不允许动态扩展，线程请求栈的深度超过当前 Java 虚拟机栈最大深度。
- `OutOfMemoryError`：若栈的内存可以动态扩展（一般不允许），虚拟机在动态扩展栈时无法申请到足够的内存空间。

#### 本地方法栈的作用？
与虚拟机栈类似，但是虚拟机栈针对的是 Java 方法（也就是字节码），而本地方法栈针对的是本地方法。

#### 堆是什么？堆有什么作用？
Java 虚拟机所管理内存最大的一块，也是所有线程共享的一块内存区域，在虚拟机启动时创建。  
作用：存放对象实例，几乎所有的对象实例以及数组都在堆中分配内存。

#### 堆内存有哪几部分？
- 新生代（包括 Eden 和 Survivor）  
- 老年代（Old）  
- 永久代（Permanent，后面变为元空间，元空间使用的是本地内存）

#### 对象在堆中各部分的迁移过程？
大部分情况，对象会首先在 Eden 分配，在一次新生代垃圾回收后，如果对象存活，就进入 S0 或 S1，并且对象年龄加 1，当年龄达到一定程度，就会晋升到老年代。具体是，Hotspot 遍历所有对象时，按照年龄从小到大对其所占用的大小进行累积，当累计的某个年龄超过了 Survivor 区的一半，取该年龄和预设的 `MaxTenuringThreshold` 中更小的一个作为年龄晋升阈值。


#### 堆最容易出现的错误？
- `java.lang.OutOfMemoryError：Overhead Limit Exceeded`：JVM 花太多时间回收垃圾并且只能回收很少的堆空间。
- `java.lang.OutOfMemoryError：Java heap space`：创建对象时堆空间不足。

#### 什么是方法区？方法区和永久代、元空间的关系？
方法区是 JVM 运行时数据区域的一块逻辑区域，是各个线程共享的内存区域。  
方法区是逻辑概念，好比是类。而永久代、元空间是方法区的实现，相当于是实例。

#### 为什么要将永久代替换为元空间？
元空间使用本地内存，空间大小比永久代大，也因此可以加载的类数更多。

#### 方法区存放哪些信息？
方法区主要用于存放已被加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。

#### 方法区常用参数有哪些？
- `-XX:MetaspaceSize=N`：初始大小
- `-XX:MaxMetaspaceSize`：最大大小

#### 运行时常量池的作用？
用于存放编译期生成的各种字面量和符号引用。  
字面量：包括整数、浮点数、字符串字面量。  
符号引用：类符号引用、字段符号引用、方法符号引用、接口符号引用。

#### 字符串常量池是什么？作用？
JVM 为了提高性能和减少内存消耗针对字符串专门开辟的一块区域。   
作用：避免字符串的重复创建。

#### 字符串常量池中保存的是什么？
- 字符串字面量
- 通过String类的intern()方法添加的字符串
- 编译器优化的字符串（比如将多个字符串合并为一个）

#### JDK1.7 为什么要将字符串常量池从永久代移动到堆中？
永久代的GC回收效率太低，只有在Full GC的时候才会被执行GC，而程序中通常有大量被创建的字符串等待回收。

#### 直接内存和堆外内存是什么？
直接内存是一种特殊的内存缓冲区，通过Java NIO（New I/O）库中的 java.nio.ByteBuffer 来分配和管理的一种内存区域。它既不是虚拟机运行时数据区域的一部分，也不是虚拟机规范中定义的内存区域。   
堆外内存是在 Java 堆之外分配的内存区域，包括直接内存和其他方式分配的内存。

#### Java 对象的创建过程是怎样的？（重点）
类加载检查 -> 分配内存 -> 初始化零值（数据类型对应的零值）-> 设置对象头（类、类元数据信息、哈希码、GC分代年龄等） -> 执行init方法

#### 内存分配有哪两种方式？
指针碰撞、空闲列表

#### 内存分配并发有哪两种方式保证线程安全？
- CAS + 失败重试
- TLAB：为每一个线程预先在 Eden 区分配一块内存，在给线程中的对象分配内存时首先在 TLAB 中分配，TLAB 不够分配时再采用 CAS 进行内存分配。

#### 对象的内存布局是怎样的？
对象头、实例数据、对齐填充（仅起占位作用）

#### 对象的访问定位有哪几种方式？
Java 程序通过栈上的 reference 数据来操作堆上的具体对象。
- 使用句柄：reference 存储对象句柄地址，句柄中存储 到对象实例数据的指针 和 到对象类型数据的指针。
- 直接指针：reference 直接存储对象的地址。