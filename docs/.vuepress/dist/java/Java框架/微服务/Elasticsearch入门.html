<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Elasticsearch入门 | java</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/java-note/images/myfavicon.png">
    <meta name="description" content="java 学习笔记">
    
    <link rel="preload" href="/java-note/assets/css/0.styles.708fcbbf.css" as="style"><link rel="preload" href="/java-note/assets/js/app.4802240e.js" as="script"><link rel="preload" href="/java-note/assets/js/2.834e1286.js" as="script"><link rel="preload" href="/java-note/assets/js/1.56911593.js" as="script"><link rel="preload" href="/java-note/assets/js/35.5d8fa2f0.js" as="script"><link rel="prefetch" href="/java-note/assets/js/10.7f863a77.js"><link rel="prefetch" href="/java-note/assets/js/11.6b66a110.js"><link rel="prefetch" href="/java-note/assets/js/12.8440333d.js"><link rel="prefetch" href="/java-note/assets/js/13.1f1fe7b4.js"><link rel="prefetch" href="/java-note/assets/js/14.65ef5a04.js"><link rel="prefetch" href="/java-note/assets/js/15.f60694df.js"><link rel="prefetch" href="/java-note/assets/js/16.efadbd73.js"><link rel="prefetch" href="/java-note/assets/js/17.d9390df8.js"><link rel="prefetch" href="/java-note/assets/js/18.2f93832a.js"><link rel="prefetch" href="/java-note/assets/js/19.e21d8298.js"><link rel="prefetch" href="/java-note/assets/js/20.c801663f.js"><link rel="prefetch" href="/java-note/assets/js/21.ed1b35e4.js"><link rel="prefetch" href="/java-note/assets/js/22.33b69923.js"><link rel="prefetch" href="/java-note/assets/js/23.d0cb6ea3.js"><link rel="prefetch" href="/java-note/assets/js/24.77c390b0.js"><link rel="prefetch" href="/java-note/assets/js/25.93636fbb.js"><link rel="prefetch" href="/java-note/assets/js/26.17ffe540.js"><link rel="prefetch" href="/java-note/assets/js/27.903242ff.js"><link rel="prefetch" href="/java-note/assets/js/28.dc5daf82.js"><link rel="prefetch" href="/java-note/assets/js/29.95e7dd6e.js"><link rel="prefetch" href="/java-note/assets/js/3.5c83221f.js"><link rel="prefetch" href="/java-note/assets/js/30.ab86d2f2.js"><link rel="prefetch" href="/java-note/assets/js/31.bb5e7344.js"><link rel="prefetch" href="/java-note/assets/js/32.a33b149c.js"><link rel="prefetch" href="/java-note/assets/js/33.e5f25c3c.js"><link rel="prefetch" href="/java-note/assets/js/34.30d8a274.js"><link rel="prefetch" href="/java-note/assets/js/36.1e873df7.js"><link rel="prefetch" href="/java-note/assets/js/37.594daa95.js"><link rel="prefetch" href="/java-note/assets/js/38.bc0467b7.js"><link rel="prefetch" href="/java-note/assets/js/39.dd90bf94.js"><link rel="prefetch" href="/java-note/assets/js/4.f186242d.js"><link rel="prefetch" href="/java-note/assets/js/40.70522d96.js"><link rel="prefetch" href="/java-note/assets/js/41.1f09c6b9.js"><link rel="prefetch" href="/java-note/assets/js/42.49f51f5c.js"><link rel="prefetch" href="/java-note/assets/js/43.29326b6e.js"><link rel="prefetch" href="/java-note/assets/js/44.8408958a.js"><link rel="prefetch" href="/java-note/assets/js/45.a061f8ad.js"><link rel="prefetch" href="/java-note/assets/js/46.7b5df9fc.js"><link rel="prefetch" href="/java-note/assets/js/47.990d3a28.js"><link rel="prefetch" href="/java-note/assets/js/48.4ae8f2d5.js"><link rel="prefetch" href="/java-note/assets/js/49.880752cc.js"><link rel="prefetch" href="/java-note/assets/js/5.377eaaa7.js"><link rel="prefetch" href="/java-note/assets/js/50.a0ba8023.js"><link rel="prefetch" href="/java-note/assets/js/51.34976563.js"><link rel="prefetch" href="/java-note/assets/js/52.23629959.js"><link rel="prefetch" href="/java-note/assets/js/53.8ad3e7eb.js"><link rel="prefetch" href="/java-note/assets/js/54.018f6f49.js"><link rel="prefetch" href="/java-note/assets/js/55.f7b9ff66.js"><link rel="prefetch" href="/java-note/assets/js/56.c1a1091c.js"><link rel="prefetch" href="/java-note/assets/js/57.a314e87a.js"><link rel="prefetch" href="/java-note/assets/js/58.b3b40ad4.js"><link rel="prefetch" href="/java-note/assets/js/59.6ca124ae.js"><link rel="prefetch" href="/java-note/assets/js/6.d127c244.js"><link rel="prefetch" href="/java-note/assets/js/60.62927391.js"><link rel="prefetch" href="/java-note/assets/js/61.9f3ed6b5.js"><link rel="prefetch" href="/java-note/assets/js/62.186bc77d.js"><link rel="prefetch" href="/java-note/assets/js/63.75fdcace.js"><link rel="prefetch" href="/java-note/assets/js/64.e3d406b8.js"><link rel="prefetch" href="/java-note/assets/js/65.b6b92143.js"><link rel="prefetch" href="/java-note/assets/js/66.a832b085.js"><link rel="prefetch" href="/java-note/assets/js/67.a165eb09.js"><link rel="prefetch" href="/java-note/assets/js/68.b710e3a6.js"><link rel="prefetch" href="/java-note/assets/js/69.8d29ae2a.js"><link rel="prefetch" href="/java-note/assets/js/7.8472e88f.js"><link rel="prefetch" href="/java-note/assets/js/70.25a2b7b3.js"><link rel="prefetch" href="/java-note/assets/js/71.fe7a34d2.js"><link rel="prefetch" href="/java-note/assets/js/vendors~docsearch.3f62eedb.js">
    <link rel="stylesheet" href="/java-note/assets/css/0.styles.708fcbbf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/java-note/" class="home-link router-link-active"><!----> <span class="site-name">java</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java框架</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>微服务</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java-note/Java/Java框架/微服务/微服务介绍.html" class="sidebar-link">微服务介绍</a></li><li><a href="/java-note/Java/Java框架/微服务/Docker入门.html" class="sidebar-link">Docker入门</a></li><li><a href="/java-note/Java/Java框架/微服务/RabbitMQ入门.html" class="sidebar-link">RabbitMQ 入门</a></li><li><a href="/java-note/Java/Java框架/微服务/Elasticsearch入门.html" class="active sidebar-link">Elasticsearch入门</a></li></ul></section></li><li><a href="/java-note/Java/Java框架/Kafka.html" class="sidebar-link">Kafka</a></li><li><a href="/java-note/Java/Java框架/SpringSecurity.html" class="sidebar-link">Spring Security</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>校园信息交流平台项目</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>简易RPC框架项目</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>内功</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>知识点自测速记</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="elasticsearch入门"><a href="#elasticsearch入门" class="header-anchor">#</a> Elasticsearch入门</h2> <ul><li>Elasticsearch简介
<ul><li>一个分布式的（多台服务器进行部署）、Restful风格（设计风格）的<strong>搜索引擎</strong></li> <li>支持对各种类型的数据的检索</li> <li>搜索速度快，可以提供实时的搜索服务</li> <li>便于水平扩展，每秒可以处理PB级海量数据</li> <li>可以理解为一个特殊的数据库，要利用ES需要将数据在ES里存一份</li></ul></li> <li>E lasticsearch术语（与mysql对比着看），在ES6.0之后要废弃类型，一个索引相当于一张表
<ul><li><strong>索引</strong>（database）、<strong>类型</strong>（table）、<strong>文档</strong>(一条数据)、<strong>字段</strong>(一列)</li> <li><strong>集群</strong>、<strong>节点</strong>(集群中的每台服务器)、<strong>分片</strong>(对索引的拆分)、<strong>副本</strong>(对分片的备份)</li></ul></li> <li>Elasticsearch使用
<ul><li>在搜索时会先将搜索的条件进行分词，再将词条进行匹配</li> <li>9200是http访问的端口，9300是TCP端口</li></ul></li></ul> <h2 id="spring-整合-elasticsearch"><a href="#spring-整合-elasticsearch" class="header-anchor">#</a> spring 整合 Elasticsearch</h2> <ul><li>引入依赖
<ul><li>spring-boot-starter-data-elasticsearch</li></ul></li> <li>配置 Elasticsearch
<ul><li>cluster-name、cluster-nodes</li></ul></li> <li>Spring Data Elasticsearch
<ul><li>ElasticsearchTemplate</li> <li>ElasticsearchRepository</li></ul></li> <li>注意点
<ul><li>redis底层依赖 netty，而 ES 底层也依赖 netty，所以需要设置 NettyUtils 的 setAvailableProcessor 避免 ES 报错</li></ul></li></ul> <h2 id="初识-elasticsearch"><a href="#初识-elasticsearch" class="header-anchor">#</a> 初识 Elasticsearch</h2> <h3 id="什么是-elasticsearch"><a href="#什么是-elasticsearch" class="header-anchor">#</a> 什么是 Elasticsearch</h3> <p>Elasticsearch 是一款非常强大的开源搜索引擎，可以帮助我们从海量数据中快速找到需要的内容。</p> <p>Elasticsearch 结合 Kibana、Logstash、Beats，就是 Elastic Stack (ELK)。ELK 被广泛应用在日志数据分析、实时监控等领域。其中，</p> <ul><li>Elasticsearch 是 ELK 的核心，负责存储、搜索、分析数据。</li> <li>Kibana 用于数据可视化。</li> <li>Logstash、Beats 用于数据抓取。</li></ul> <h3 id="什么是-lucence"><a href="#什么是-lucence" class="header-anchor">#</a> 什么是 Lucence</h3> <p>Lucene 是一个 Java 语言的搜索引擎类库，是 Apache 公司的顶级项目，由 DougCutting 于 1999 年研发。<br>
Lucene 的优势：易扩展、高性能（基于倒排索引）。<br>
Lucene 的缺点：只限于 Java 语言开发、学习曲线陡峭、不支持水平扩展。</p> <p>2004年 Shay Banon 基于 Lucene 开发了 Compass。<br>
2010年 Shay Banon 重写了 Compass，取名为 Elasticsearch。</p> <p>相比于 Lucene，Elasticsearch 具备下列优势：</p> <ul><li>支持分布式，可水平扩展。</li> <li>提供 Restful 接口，可被任何语言调用。</li></ul> <h3 id="文档、词条、索引、映射"><a href="#文档、词条、索引、映射" class="header-anchor">#</a> 文档、词条、索引、映射</h3> <p>在 ES 中，有几个概念需要了解一下，跟传统的数据库 MySQL 不一样。</p> <ul><li>文档：Elasticsearch 是面向文档存储的，每一条数据就是一个文档，可以是数据库中的一条商品数据，一个订单信息。文档数据会被序列化为 JSON 格式后存储在 Elasticsearch 中。</li> <li>词条： 对文档中的内容分词，得到的词语就是词条。</li> <li>索引：相同类型的文档的集合。</li> <li>映射：索引中文档的字段约束信息，类似表的结构约束。</li></ul> <div align="center"><img src="/java-note/assets/img/MySQL和ES中概念对比.fcb1b811.png" width="100%"></div> <h3 id="正向索引和倒排索引"><a href="#正向索引和倒排索引" class="header-anchor">#</a> 正向索引和倒排索引</h3> <p>传统数据库是采用正向索引的，但 Elasticsearch 是按照倒排索引。这两种索引的区别如下：</p> <ul><li>正向索引是按照 <strong>文档-词条</strong> 的方式组织的索引，一般是基于文档 id 创建的索引。每个文档都包含了它包含的词项以及相关的其他信息，比如词条的位置、频率等。这种结构更适合用于检索某个文档的内容，传统数据库如 MySQL 采用的就是这种。</li> <li>倒排索引是按照 <strong>词条-文档</strong> 的方式组织的索引，基于词条创建索引。对于每个词条，记录包含该词条的所有文档信息。这种结构更适合用于搜索某个词条在哪些文档中出现。</li></ul> <div align="center"><img src="/java-note/assets/img/正向索引和倒排索引.d4e467b0.png" width="100%"></div> <br> <p>倒排索引中包含两部分内容：</p> <ul><li>词条词典（Term Dictionary）：记录所有词条，以及词条与倒排列表（Posting List）之间的关系，会给词条创建索引，提高查询和插入效率。</li> <li>倒排列表（Posting List）：记录词条所在的文档 id、词条出现频率、词条在文档中的位置等信息。
<ul><li>文档 id：用于快速获取文档。</li> <li>词条频率(TF)：词条在文档中出现的次数，用于评分。</li></ul></li></ul> <p>倒排索引的搜索流程如下：</p> <ol><li>对用户输入内容分词，得到词条。</li> <li>根据词条在倒排索引中查找，可以得到包含词条的文档 id。</li> <li>根据文档 id 到正向索引中查找具体文档。</li></ol> <h3 id="分词器"><a href="#分词器" class="header-anchor">#</a> 分词器</h3> <p>es 在创建倒排索引的时候需要对文档分词；在搜索时，需要对用户输入内容分词。它默认的分词规则对中文处理不太友好，可以在 kibana 中测试：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token constant">POST</span> <span class="token operator">/</span>_analyze
<span class="token punctuation">{</span>
  <span class="token string">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;standard&quot;</span>
  <span class="token string">&quot;text&quot;</span><span class="token operator">:</span> <span class="token string">&quot;分词器测试&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中，</p> <ul><li><code>POST</code>：请求方式</li> <li><code>/-analyzer</code>：请求路径，这里省略了 ip 和 端口，由 kibana 帮我们补充</li> <li>请求参数：json 风格，<code>analyzer</code> 是分词器类型，这里是默认的 <code>standard</code> 分词器，<code>text</code> 是要分词的内容。</li></ul> <p>由于默认的 <code>standard</code> 分词器对中文不太友好，因此处理中文分词，一般会使用 IK 分词器。它的安装上网查即可，这里就不提了。<br>
IK 分词器包含两种模式：</p> <ul><li><code>ik_smart</code>：按词切分，不重复包含字，最少切分，粗粒度。例如，“分词器测试” 会被分为 “分词器” 和 “测试” 这两个词条。</li> <li><code>ik_max_word</code>：按词切分后，还按字切分，最细切分，细粒度。例如，“分词器测试” 会被分词为 “分词器”、“分词”、“分”、“词”、“器”、“测试”、“测”、“试” 这么多个词条。</li></ul> <h4 id="ik-分词器-扩展词库"><a href="#ik-分词器-扩展词库" class="header-anchor">#</a> IK 分词器——扩展词库</h4> <p>除了现有的词库，我们还可以扩展 IK 分词器的词库，只需要修改 IK 分词器目录中的 config 目录中的 IkAnalyzer.cfg.xml 文件：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>comment</span><span class="token punctuation">&gt;</span></span>IK Analyzer 扩展配置<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>comment</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--用户可以在这里配置自己的扩展字典 *** 添加扩展词典--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ext_dict<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>ext.dic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>然后在 ext.dic 文件中，添加想要扩展的词语即可。</p> <h4 id="ik-分词器-停用词库"><a href="#ik-分词器-停用词库" class="header-anchor">#</a> IK 分词器——停用词库</h4> <p>我们还可以禁止某些敏感词条，同样是在 IkAnalyzer.cfg.xml 文件中修改：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>comment</span><span class="token punctuation">&gt;</span></span>IK Analyzer 扩展配置<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>comment</span><span class="token punctuation">&gt;</span></span>
         <span class="token comment">&lt;!--用户可以在这里配置自己的扩展停止词字典  *** 添加停用词词典--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ext_stopwords<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>stopword.dic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>然后在 ext_stopword.dic 文件中添加想要禁止的敏感词即可。</p> <h2 id="索引库操作"><a href="#索引库操作" class="header-anchor">#</a> 索引库操作</h2> <h3 id="mapping-属性"><a href="#mapping-属性" class="header-anchor">#</a> mapping 属性</h3> <p>mapping 是对索引库中文档的约束，常见的 mapping 属性包括：</p> <ul><li>type：字段数据类型，常见的简单类型有：
<ul><li>字符串：text（可分词的文本）、keyword（精确值，例如：品牌、国家、ip 地址）</li> <li>数值：long、integer、short、byte、double、float</li> <li>布尔：boolean</li> <li>日期：date</li> <li>对象：object</li></ul></li> <li>index：是否创建索引，默认为 true</li> <li>analyzer：使用哪种分词器</li> <li>properties：该字段的子字段</li></ul> <p>以下面的字段为例：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token number">21</span><span class="token punctuation">,</span>
    <span class="token property">&quot;weight&quot;</span><span class="token operator">:</span> <span class="token number">52.1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;isMarried&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">&quot;info&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mapping属性例子&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token string">&quot;myc@itcast.cn&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;score&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">99.1</span><span class="token punctuation">,</span> <span class="token number">99.5</span><span class="token punctuation">,</span> <span class="token number">98.9</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;firstName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;彦祖&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;lastName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;吴&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对应每个字段的映射应为：</p> <ul><li>age：类型为 integer；参与搜索，因此需要 index 为 true；无需分词器。</li> <li>weight：类型为float；参与搜索，因此需要 index 为 true；无需分词器。</li> <li>isMarried：类型为 boolean；参与搜索，因此需要 index 为 true；无需分词器。</li> <li>info：类型为字符串，需要分词，因此是 text；参与搜索，因此需要 index 为 true；分词器可以用ik_smart。</li> <li>email：类型为字符串，但是不需要分词，因此类型是 keyword；不参与搜索，因此需要 index 为false；无需分词器。</li> <li>score：虽然是数组，但是只看元素的类型，类型为 float；参与搜索，因此需要 index 为 true；无需分词器。</li> <li>name：类型为 object，需要定义多个子属性。
<ul><li>name.firstName：类型为字符串，但是不需要分词，因此是 keyword；参与搜索，因此需要 index 为 true；无需分词器。</li> <li>name.lastName：类型为字符串，不需要分词，类型是 keyword；参与搜索，因此需要 index 为 true；无需分词器。</li></ul></li></ul> <h3 id="创建索引库"><a href="#创建索引库" class="header-anchor">#</a> 创建索引库</h3> <p>ES 中通过 Restful 请求操作索引库和文档。请求内容用 DSL (Domain Specific Language) 语句来表示。</p> <p>创建索引库和 mapping 的 DSL 语法如下：</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT /索引库名称
<span class="token punctuation">{</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;字段名1&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;字段名2&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;false&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;字段名3&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;子字段&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;false&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// ...略</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="查询索引库"><a href="#查询索引库" class="header-anchor">#</a> 查询索引库</h3> <div class="language-json extra-class"><pre class="language-json"><code>GET /索引库名
</code></pre></div><h3 id="修改索引库"><a href="#修改索引库" class="header-anchor">#</a> 修改索引库</h3> <p>倒排索引结构虽然不复杂，但是一旦数据结构改变（比如改变了分词器），就需要重新创建倒排索引，这简直是灾难。因此索引库一旦创建，无法修改 mapping。<br>
虽然无法修改 mapping 中已有的字段，但是却允许添加新的字段到 mapping 中，因为不会对倒排索引产生影响。</p> <p>添加新字段：</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT /索引库名/_mapping
<span class="token punctuation">{</span>
  <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;新字段名&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integer&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="删除索引库"><a href="#删除索引库" class="header-anchor">#</a> 删除索引库</h3> <div class="language-json extra-class"><pre class="language-json"><code>DELETE /索引库名
</code></pre></div><h2 id="文档操作"><a href="#文档操作" class="header-anchor">#</a> 文档操作</h2> <h3 id="新增文档"><a href="#新增文档" class="header-anchor">#</a> 新增文档</h3> <div class="language-json extra-class"><pre class="language-json"><code>POST /索引库名/_doc/文档id
<span class="token punctuation">{</span>
    <span class="token property">&quot;字段1&quot;</span><span class="token operator">:</span> <span class="token string">&quot;值1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;字段2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;值2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;字段3&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;子属性1&quot;</span><span class="token operator">:</span> <span class="token string">&quot;值3&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;子属性2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;值4&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="查询文档"><a href="#查询文档" class="header-anchor">#</a> 查询文档</h3> <div class="language-json extra-class"><pre class="language-json"><code>GET /索引库名/_doc/文档id
</code></pre></div><h3 id="删除文档"><a href="#删除文档" class="header-anchor">#</a> 删除文档</h3> <div class="language-json extra-class"><pre class="language-json"><code>DELETE /索引库名/_doc/文档id
</code></pre></div><h3 id="修改文档"><a href="#修改文档" class="header-anchor">#</a> 修改文档</h3> <p>对于修改文档，有两种方式：</p> <ul><li>全量修改：直接覆盖原来的文档，其本质是先删除文档，再新建一个。值得注意的是，当 id 不存在时，虽然没有了删除操作，但新增操作还是会执行，此时修改操作就变成了新增操作。</li> <li>增量修改：修改文档中的部分字段。</li></ul> <p>对于全量修改，其语法是：</p> <div class="language-json extra-class"><pre class="language-json"><code>PUT /索引库名/_doc/文档id
<span class="token punctuation">{</span>
    <span class="token property">&quot;字段1&quot;</span><span class="token operator">:</span> <span class="token string">&quot;值1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;字段2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;值2&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// ... 略</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于增量修改，其语法是：</p> <div class="language-json extra-class"><pre class="language-json"><code>POST /索引库名/_update/文档id
<span class="token punctuation">{</span>
    <span class="token property">&quot;doc&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
         <span class="token property">&quot;字段名&quot;</span><span class="token operator">:</span> <span class="token string">&quot;新的值&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意：全量修改对应的是 <code>PUT</code> 和 <code>_doc</code>，增量修改对应的是 <code>POST</code> 和 <code>_update</code>。</p> <h3 id="动态映射"><a href="#动态映射" class="header-anchor">#</a> 动态映射</h3> <p>当我们向 ES 中插入文档时，如果文档中字段没有对应的 mapping，ES 会帮助我们字段设置 mapping，规则如下：</p> <ul><li>字符串：
<ul><li>日期格式字符串：mapping 为 date 类型。</li> <li>普通字符串：mapping 为 text 类型，并添加 keyword 类型子字段。</li></ul></li> <li>布尔值：boolean</li> <li>浮点数：float</li> <li>整数：long</li> <li>对象嵌套：object，并添加 properties。</li> <li>数组，由数组中第一个非空类型决定。</li> <li>空值：忽略。</li></ul> <h2 id="restapi"><a href="#restapi" class="header-anchor">#</a> RestAPI</h2> <p>ES 官方提供了各种不同语言的客户端，用来操作 ES。<strong>这些客户端的本质就是组装 DSL 语句，通过 HTTP 请求发送给 ES。</strong> 官方文档地址：https://www.elastic.co/guide/en/elasticsearch/client/index.html。</p> <p>其中，Java Rest Client 包括了两种：</p> <ul><li>Java Low Level Rest Client</li> <li>Java High Level Rest Client</li></ul> <h3 id="初始化-restclient"><a href="#初始化-restclient" class="header-anchor">#</a> 初始化 RestClient</h3> <p>在 ES 提供的 API 中，与 ES 一切交互都封装在一个名为 RestHighLevelClient 得到类中，要对 ES 进行操作，必须先完成这个对象的初始化，建立与 ES 的连接。</p> <p>步骤如下：</p> <ol><li>引入 ES 的 RestHighLevelClient 依赖：</li></ol> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.elasticsearch.client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>elasticsearch-rest-high-level-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>7.12.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="2"><li>初始化 RestHighLevelClient：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">RestHighLevelClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
  <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;http://192.168.150.101:9200&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="restclient-操作索引库"><a href="#restclient-操作索引库" class="header-anchor">#</a> RestClient 操作索引库</h3> <h4 id="restclient-创建索引库"><a href="#restclient-创建索引库" class="header-anchor">#</a> RestClient 创建索引库</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.创建 Request 对象</span>
    <span class="token class-name">CreateIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateIndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;hotel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.设置请求参数</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token constant">MAPPING_TEMPLATE</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里说明一下这三步：</p> <ol><li>创建 Request 对象。因为是创建索引库的操作，所以是 <code>CreateIndexRequest</code>。</li> <li>设置请求参数。这里其实就是设置 DSL 的 JSON 参数部分，也就是 mapping 部分。因为 JSON 字符串很长，所以这里将其定义为 <code>MAPPING_TEMPLATE</code>，让代码看起来更加优雅。</li> <li>发送请求。<code>client.indices()</code> 方法返回值是 <code>indicesClient</code> 类型，封装了所有与索引库操作相关的方法。</li></ol> <h4 id="restclient-删除索引库"><a href="#restclient-删除索引库" class="header-anchor">#</a> RestClient 删除索引库</h4> <p>类似的，RestClient 删除索引库的代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testDeleteIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 创建 Request 对象</span>
  <span class="token class-name">DeleteIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteIndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;hotel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2. 发送请求</span>
  client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="restclient-判断索引库是否存在"><a href="#restclient-判断索引库是否存在" class="header-anchor">#</a> RestClient 判断索引库是否存在</h4> <p>判断索引库是否存在，本质就是查询，对应的 DSL 是 <code>GET /索引库</code>，用 RestClient 的步骤如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testExitsIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token class-name">GetIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetIndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;hotel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 注意，这里是 exists() 方法，不是 get()</span>
  <span class="token keyword">boolean</span> exists <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>exists <span class="token operator">?</span> <span class="token string">&quot;索引库已经存在！&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;索引库不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="restclient-操作文档"><a href="#restclient-操作文档" class="header-anchor">#</a> RestClient 操作文档</h3> <p>这里先总的说一下文档操作的基本步骤：</p> <ol><li>初始化 <code>RestHighLevelClient</code></li> <li>创建 xxxRequest。xxx 是 Index、Get、Update、Delete。</li> <li>准备参数(Index 和 Update 时需要)</li> <li>发送请求。调用 RestHighLevelClient.xxx() 方法，xxx 是 index、get、update、delete。</li> <li>解析结果（Get 时需要）</li></ol> <h4 id="新增文档-2"><a href="#新增文档-2" class="header-anchor">#</a> 新增文档</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testAddDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 根据 id 查询数据库中酒店数据</span>
  <span class="token class-name">Hotel</span> hotel <span class="token operator">=</span> hotelService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span><span class="token number">61083L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2. 将类型转换为文档类型，因为 Hotel 是对应 MySQL 数据库中数据的类，而 HotelDoc 是对应 ES 中数据的类，主要是地理坐标字段不一样</span>
  <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>hotel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3. 将 HotelDoc 转 json</span>
  <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 4. 准备 Request 对象</span>
  <span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;hotel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 5. 准备要新增的文档数据，也就是上面的 json</span>
  request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 6. 发送请求</span>
  client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="查询文档-2"><a href="#查询文档-2" class="header-anchor">#</a> 查询文档</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testGetDocumentById</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token class-name">GetRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetRequest</span><span class="token punctuation">(</span><span class="token string">&quot;hotel&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;61082&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">GetResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 请求的结果是一个 JSON，其中文档放在一个 _source 属性中，所以要 getSourceAsString() 方法获取</span>
  <span class="token class-name">String</span> json <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将文档从 JSON 格式解析出来，也就是反序列化</span>
  <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="删除文档-2"><a href="#删除文档-2" class="header-anchor">#</a> 删除文档</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testDeleteDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token class-name">DeleteRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span><span class="token string">&quot;hotel&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;61083&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="修改文档-2"><a href="#修改文档-2" class="header-anchor">#</a> 修改文档</h4> <p>我们上面说过，修改有两种方式：全量修改和增量修改。</p> <p>在 RestClient 的 API 中，全量修改与新增的 API 完全一致，判断依据是 ID：</p> <ul><li>如果新增时，ID 已经存在，则是修改。</li> <li>如果新增时，ID 不存在，则是新增。</li></ul> <p>所以，这里不对全量修改进行赘述，主要说一下增量修改：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testUpdateDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token class-name">UpdateRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateRequest</span><span class="token punctuation">(</span><span class="token string">&quot;hotel&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;61083&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 修改的参数是每两个参数为一对 key value</span>
  request<span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>
    <span class="token string">&quot;price&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;952&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;starName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;五星&quot;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  client<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="批量导入文档"><a href="#批量导入文档" class="header-anchor">#</a> 批量导入文档</h4> <p>如果要批量导入数据到 ES，可以利用 <code>BulkRequest</code>。<code>BulkRequest</code> 本质就是将多个普通的 CRUD 请求组合在一起发送。其中提供了一个 <code>add()</code> 方法，用来添加请求。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testBulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token comment">// 批量查询酒店数据</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Hotel</span><span class="token punctuation">&gt;</span></span> hotels <span class="token operator">=</span> hotelService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 1.创建 Request</span>
  <span class="token class-name">BulkRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2.准备参数，添加多个新增的 Request</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Hotel</span> hotel <span class="token operator">:</span> hotels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 2.1.转换为文档类型 HotelDoc</span>
    <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>hotel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.2.创建新增文档的 Request 对象</span>
    request<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">&quot;hotel&quot;</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 3.发送请求</span>
  client<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/java-note/Java/Java框架/微服务/RabbitMQ入门.html" class="prev">
        RabbitMQ 入门
      </a></span> <span class="next"><a href="/java-note/Java/Java框架/Kafka.html">
        Kafka
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/java-note/assets/js/app.4802240e.js" defer></script><script src="/java-note/assets/js/2.834e1286.js" defer></script><script src="/java-note/assets/js/1.56911593.js" defer></script><script src="/java-note/assets/js/35.5d8fa2f0.js" defer></script>
  </body>
</html>
