<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis一点点细节 | The Note of HelloWorldYC</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/Note/images/myfavicon.png">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/Note/assets/css/0.styles.44b4951f.css" as="style"><link rel="preload" href="/Note/assets/js/app.e371fa6c.js" as="script"><link rel="preload" href="/Note/assets/js/3.f13ea13a.js" as="script"><link rel="preload" href="/Note/assets/js/38.badb0163.js" as="script"><link rel="prefetch" href="/Note/assets/js/10.96adacd6.js"><link rel="prefetch" href="/Note/assets/js/11.3306ac33.js"><link rel="prefetch" href="/Note/assets/js/12.c6ec3b17.js"><link rel="prefetch" href="/Note/assets/js/13.6fd90bb8.js"><link rel="prefetch" href="/Note/assets/js/14.d2796fb6.js"><link rel="prefetch" href="/Note/assets/js/15.71825424.js"><link rel="prefetch" href="/Note/assets/js/16.69fe96f8.js"><link rel="prefetch" href="/Note/assets/js/17.6422db44.js"><link rel="prefetch" href="/Note/assets/js/18.bef0a5a8.js"><link rel="prefetch" href="/Note/assets/js/19.a6fadc0d.js"><link rel="prefetch" href="/Note/assets/js/2.96565d4b.js"><link rel="prefetch" href="/Note/assets/js/20.cc630c63.js"><link rel="prefetch" href="/Note/assets/js/21.84d0ce12.js"><link rel="prefetch" href="/Note/assets/js/22.2ae8180f.js"><link rel="prefetch" href="/Note/assets/js/23.1ee24d88.js"><link rel="prefetch" href="/Note/assets/js/24.5cc62c6d.js"><link rel="prefetch" href="/Note/assets/js/25.0266f62e.js"><link rel="prefetch" href="/Note/assets/js/26.79e8e570.js"><link rel="prefetch" href="/Note/assets/js/27.9cb81067.js"><link rel="prefetch" href="/Note/assets/js/28.bec84c38.js"><link rel="prefetch" href="/Note/assets/js/29.8411b6a0.js"><link rel="prefetch" href="/Note/assets/js/30.4bfbbfe1.js"><link rel="prefetch" href="/Note/assets/js/31.214d2c09.js"><link rel="prefetch" href="/Note/assets/js/32.7079239e.js"><link rel="prefetch" href="/Note/assets/js/33.d8cb1746.js"><link rel="prefetch" href="/Note/assets/js/34.ea58bbfc.js"><link rel="prefetch" href="/Note/assets/js/35.55034762.js"><link rel="prefetch" href="/Note/assets/js/36.46bd4ff5.js"><link rel="prefetch" href="/Note/assets/js/37.d1572595.js"><link rel="prefetch" href="/Note/assets/js/39.a3b7063b.js"><link rel="prefetch" href="/Note/assets/js/4.20687415.js"><link rel="prefetch" href="/Note/assets/js/40.74351d6a.js"><link rel="prefetch" href="/Note/assets/js/41.4efaa171.js"><link rel="prefetch" href="/Note/assets/js/42.0b3c1bcf.js"><link rel="prefetch" href="/Note/assets/js/43.84b7d7c1.js"><link rel="prefetch" href="/Note/assets/js/44.0b47ccbe.js"><link rel="prefetch" href="/Note/assets/js/45.955b6048.js"><link rel="prefetch" href="/Note/assets/js/46.2141e252.js"><link rel="prefetch" href="/Note/assets/js/47.645a9b50.js"><link rel="prefetch" href="/Note/assets/js/48.cde4ae1f.js"><link rel="prefetch" href="/Note/assets/js/49.e744e599.js"><link rel="prefetch" href="/Note/assets/js/5.0f586f5f.js"><link rel="prefetch" href="/Note/assets/js/50.65030a6a.js"><link rel="prefetch" href="/Note/assets/js/51.9452762b.js"><link rel="prefetch" href="/Note/assets/js/52.971525fc.js"><link rel="prefetch" href="/Note/assets/js/53.7608ac83.js"><link rel="prefetch" href="/Note/assets/js/54.00f97db1.js"><link rel="prefetch" href="/Note/assets/js/55.d0a27a03.js"><link rel="prefetch" href="/Note/assets/js/56.2af364aa.js"><link rel="prefetch" href="/Note/assets/js/57.1840d8bd.js"><link rel="prefetch" href="/Note/assets/js/58.b9b19a76.js"><link rel="prefetch" href="/Note/assets/js/59.51b325d0.js"><link rel="prefetch" href="/Note/assets/js/6.bd27afd1.js"><link rel="prefetch" href="/Note/assets/js/60.c0d12417.js"><link rel="prefetch" href="/Note/assets/js/61.d74bff09.js"><link rel="prefetch" href="/Note/assets/js/62.e8dd995e.js"><link rel="prefetch" href="/Note/assets/js/63.2040b659.js"><link rel="prefetch" href="/Note/assets/js/64.a49f7bc6.js"><link rel="prefetch" href="/Note/assets/js/65.aa4bc4a6.js"><link rel="prefetch" href="/Note/assets/js/66.ec3e1eb9.js"><link rel="prefetch" href="/Note/assets/js/7.ee931d89.js"><link rel="prefetch" href="/Note/assets/js/8.0118dbfd.js"><link rel="prefetch" href="/Note/assets/js/9.f1a20ae7.js">
    <link rel="stylesheet" href="/Note/assets/css/0.styles.44b4951f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Note/" class="home-link router-link-active"><!----> <span class="site-name">The Note of HelloWorldYC</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>matlab</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>无人机项目</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数字图像处理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>深度学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>信源数估计</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Java基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Java框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>校园信息交流平台项目</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>简易RPC框架项目</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>内功</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading"><span>MySQL</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading open"><span>Redis</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Note/Java/内功/Redis/Redis总体架构.html" class="sidebar-link">Redis总体架构</a></li><li><a href="/Note/Java/内功/Redis/Redis一点点细节.html" class="active sidebar-link">Redis一点点细节</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Note/Java/内功/Redis/Redis一点点细节.html#redis-持久化机制" class="sidebar-link">Redis 持久化机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Note/Java/内功/Redis/Redis一点点细节.html#aof-重写" class="sidebar-link">AOF 重写</a></li></ul></li><li class="sidebar-sub-header"><a href="/Note/Java/内功/Redis/Redis一点点细节.html#redis-事务" class="sidebar-link">Redis 事务</a></li><li class="sidebar-sub-header"><a href="/Note/Java/内功/Redis/Redis一点点细节.html#redis-性能优化" class="sidebar-link">Redis 性能优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Note/Java/内功/Redis/Redis一点点细节.html#惰性删除-lazy-deletion-和延迟释放-lazy-free-的区别" class="sidebar-link">惰性删除（lazy deletion）和延迟释放（lazy free）的区别？</a></li></ul></li><li class="sidebar-sub-header"><a href="/Note/Java/内功/Redis/Redis一点点细节.html#redis-内存碎片" class="sidebar-link">Redis 内存碎片</a></li><li class="sidebar-sub-header"><a href="/Note/Java/内功/Redis/Redis一点点细节.html#redis-生产问题" class="sidebar-link">Redis 生产问题</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><p class="sidebar-heading"><span>操作系统</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><a href="/Note/Java/八股自测速记之JVM.html" class="sidebar-link">八股自测速记之JVM</a></li><li><a href="/Note/Java/八股自测速记之Spring.html" class="sidebar-link">八股自测速记之Spring</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="redis-持久化机制"><a href="#redis-持久化机制" class="header-anchor">#</a> Redis 持久化机制</h2> <h3 id="aof-重写"><a href="#aof-重写" class="header-anchor">#</a> AOF 重写</h3> <p>AOF 重写（rewrite）是一个有歧义的名字，该功能是<strong>通过读取数据库中的键值对来实现</strong>，程序<strong>无须</strong>对现有 AOF 文件进行任何读写、分析或者写入操作。<br>
AOF 重写触发时机有两种，一种是通过设置AOF文件大小，默认是 64 MB，超过则重写；另一种是设置当前 AOF 大小和上一次重写时 AOF 大小的比值，超过比值则重写。<br> <strong>既然 AOF 重写是读取数据库中键值对来实现的，为什么不直接采用 RDB，那样不是会更简单吗？</strong><br>
这个问题其实也就是 AOF 和 RDB 的优劣势问题，各有优势也各有短板，AOF 主要比 RDB 好的地方就是实时性比较好，数据安全性比较高，可以导出 AOF 文件进行分析调错。</p> <h2 id="redis-事务"><a href="#redis-事务" class="header-anchor">#</a> Redis 事务</h2> <p>Redis 事务实际上是一系列命令的打包执行，与 MySQL 这些的事务不一样。<br>
Redis 事务不支持原子性，但支持持久性（AOF 和 RDB）。<br> <strong>如何解决 Redis 事务的缺陷？</strong> 可以使用 Lua 脚本，一段 Lua 脚本可以当作一条命令来执行，一段 Lua 脚本的执行过程中不会有其他脚本或 Redis 命令同时执行，保证了操作不会被打断（<strong>隔离性</strong>）。但是，如果操作失败并不会回滚数据，因此使用 Lua 脚本也不满足原子性。</p> <h2 id="redis-性能优化"><a href="#redis-性能优化" class="header-anchor">#</a> Redis 性能优化</h2> <ul><li>使用批量操作减少网络传输：减少了 Round Trip Time (RTT，往返时间)，即数据在网络上传输的时间；也减少了 发送命令的 socket I/O 成本。</li> <li>大量 key 集中过期问题：定期删除过期 key 任务需要在主线程中执行，若在这过程有大量 key 过期，会影响请求的响应。解决方法一是给 key 设置随机过期时间；二是开启 lazy-free 延迟释放，让 redis 采用异步方式延迟释放 key 使用的内存，交给子线程处理。</li> <li>处理 Redis big key：一是分割 big key；二是手动清理；三是采用合适的数据结构。</li> <li>处理 redis hotkey：一是读写分离；二是使用 Redis 集群，将热点数据分散存储在多个节点上；三是使用二级缓存，将热点数据存放一份到 JVM 本地内存中。</li></ul> <h3 id="惰性删除-lazy-deletion-和延迟释放-lazy-free-的区别"><a href="#惰性删除-lazy-deletion-和延迟释放-lazy-free-的区别" class="header-anchor">#</a> 惰性删除（lazy deletion）和延迟释放（lazy free）的区别？</h3> <p>&quot;Lazy Free&quot; 和 &quot;Lazy Deletion&quot; 都是 Redis 中与内存管理和键的过期相关的概念，但它们有不同的含义和用途。</p> <ol><li><p><strong>Lazy Free（惰性释放）：</strong></p> <ul><li>&quot;Lazy Free&quot; 是指 Redis 在内存管理方面的一种策略。</li> <li>当一个键被删除或过期时，Redis 并不立即释放与该键相关联的内存。相反，它会将这些键的内存标记为 &quot;tombstone&quot;（墓碑），并稍后在内存需要时，通过回收这些标记为 &quot;tombstone&quot; 的内存来进行重用。</li> <li>这种策略的优势在于避免了频繁的内存分配和释放操作，从而减少了内存碎片的产生，提高了性能。然而，它可能会导致 Redis 的内存占用在键被删除或过期后仍然会有一定时间的增加。</li></ul></li> <li><p><strong>Lazy Deletion（惰性删除）：</strong></p> <ul><li>&quot;Lazy Deletion&quot; 是指 Redis 在处理键的过期时的一种策略。</li> <li>当一个键过期时，并不会立即将它从数据库中删除。相反，它会等到有客户端请求访问该键时，才会在访问时检查键是否过期，并在需要时删除。</li> <li>这种策略的优势在于避免了在键过期时产生立即的删除操作，从而减轻了对性能的影响。然而，它可能会导致过期键在数据库中积压，直到有客户端请求访问这些键。</li></ul></li></ol> <p>综上所述，&quot;Lazy Free&quot; 主要关注内存管理，通过延迟释放内存来提高性能并减少内存碎片。&quot;Lazy Deletion&quot; 则关注键的过期处理，通过延迟实际删除过期键来减轻性能影响。这两种策略在 Redis 中都是为了优化性能和内存使用而采取的手段。</p> <h2 id="redis-内存碎片"><a href="#redis-内存碎片" class="header-anchor">#</a> Redis 内存碎片</h2> <p>Redis 内存碎片率计算公式：mem_fragmentation_ratio （内存碎片率）= used_memory_rss (操作系统实际分配给 Redis 的物理内存空间大小)/ used_memory(Redis 内存分配器为了存储数据实际申请使用的内存空间大小)<br> <strong>一定不要误认为 used_memory_rss 减去 used_memory 值就是内存碎片的大小！！！这不仅包括内存碎片，还包括其他进程开销，以及共享库、堆栈等的开销。</strong></p> <h2 id="redis-生产问题"><a href="#redis-生产问题" class="header-anchor">#</a> Redis 生产问题</h2> <ul><li>缓存穿透：大量请求的 key 不合理，根本不存在于缓存中，也不存在于数据库中。解决方法一是缓存无效 key，二是使用布隆过滤器。<strong>布隆过滤器说某个元素存在，小概率会误判。布隆过滤器说某个元素不在，那么这个元素一定不在。</strong></li> <li>缓存击穿：请求的 key 对应的是热点数据 ，该数据存在于数据库中，但不存在于缓存中（通常是因为缓存中的那份数据已经过期）。解决方法一是设置热点数据永不过期或过期时间较长，二是提前将热点数据存入缓存并设置合理过期时间，三是设置互斥锁保证只有一个请求落到数据库。</li> <li>缓存雪崩：缓存在同一时间大面积的失效，导致大量的请求都直接落到了数据库上，对数据库造成了巨大的压力，比如实例宕机。针对 Redis 服务不可用解决方法一是采用集群避免单机出现问题，二是限流避免同时处理大量请求；针对热点缓存同时失效解决方法一是随机设置不同的过期时间，二是缓存永不失效，三是设置二级缓存。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Note/Java/内功/Redis/Redis总体架构.html" class="prev">
        Redis总体架构
      </a></span> <span class="next"><a href="/Note/Java/内功/操作系统/导论.html">
        操作系统导论
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/Note/assets/js/app.e371fa6c.js" defer></script><script src="/Note/assets/js/3.f13ea13a.js" defer></script><script src="/Note/assets/js/38.badb0163.js" defer></script>
  </body>
</html>
